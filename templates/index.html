<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Quiz Audio Web App</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
	<h1>Quiz</h1>
	<div id="question">Loading question...</div>
	
	<div id="recorder-container">
		<div id="wave-container">
			<canvas id="audio-wave"></canvas>
		</div>
		<button id="recordCircleBtn">
			<span id="micIcon">&#127908;</span> <!-- Microphone icon Unicode -->
		</button>
	</div>

	<div id="result"></div>

	<script src="{{ url_for('static', filename='js/recorder.js') }}"></script>
	<script>
	let recorder, audioStream, audioContext, analyser, dataArray, animationId;
	let isRecording = false;

	async function getQuestion() {
		const res = await fetch('/question');
		const data = await res.json();
		document.getElementById('question').innerText = data.question;
	}
	getQuestion();

	const recordBtn = document.getElementById('recordCircleBtn');
	const waveCanvas = document.getElementById('audio-wave');
	const waveCtx = waveCanvas.getContext('2d');
	waveCanvas.width = 220;
	waveCanvas.height = 60;

	function drawWave() {
		if (!isRecording || !analyser) return;
		analyser.getByteTimeDomainData(dataArray);
		waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);

		waveCtx.beginPath();
		const sliceWidth = waveCanvas.width * 1.0 / dataArray.length;
		let x = 0;
		for (let i = 0; i < dataArray.length; i++) {
			let v = dataArray[i] / 128.0;
			let y = v * waveCanvas.height / 2;
			if (i === 0) {
				waveCtx.moveTo(x, y);
			} else {
				waveCtx.lineTo(x, y);
			}
			x += sliceWidth;
		}
		waveCtx.lineTo(waveCanvas.width, waveCanvas.height / 2);
		waveCtx.strokeStyle = '#3b82f6';
		waveCtx.lineWidth = 3;
		waveCtx.stroke();

		animationId = requestAnimationFrame(drawWave);
	}

	recordBtn.onclick = async function() {
		if (!isRecording) {
			audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
			audioContext = new (window.AudioContext || window.webkitAudioContext)();
			const input = audioContext.createMediaStreamSource(audioStream);
			analyser = audioContext.createAnalyser();
			analyser.fftSize = 2048;
			dataArray = new Uint8Array(analyser.fftSize);

			input.connect(analyser);

			recorder = new Recorder(input, { numChannels: 1 });
			recorder.record();

			isRecording = true;
			recordBtn.classList.add('recording');
			drawWave();
			document.getElementById('result').innerText = '';
		} else {
			recorder.stop();
			audioStream.getAudioTracks()[0].stop();
			audioContext.close();
			cancelAnimationFrame(animationId);

			recorder.exportWAV(function(blob) {
				const formData = new FormData();
				formData.append('audio', blob, 'audio.wav');
				fetch('/answer', { method: 'POST', body: formData })
					.then(r => r.json())
					.then(data => {
						document.getElementById('result').innerText =
							"Result: " + (data.correct ? "Correct!" : "Wrong!") +
							"\nYou said: " + data.transcript;
						getQuestion();
					});
			});

			isRecording = false;
			recordBtn.classList.remove('recording');
			waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
		}
	};
	</script>
</body>
</html>
